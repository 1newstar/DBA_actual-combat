# 实施详细
```shell
# 本地连接公司杭州跳板机
[c:\~]$ ssh 669a68_weiyaping@115.29.244.224 9998
[weiyaping@srv-zy-ssh1 ~]$

# 连接尔格客户的gatway
ssh erge-opertion
zyadmin tfzRa3AqGwW8OTkICJ2f


[weiyaping@srv-zy-ssh1 ~]$ ssh erge-opertion
[zyadmin@erge-gateway ~]$

# 从客户gateway连接app01
[zyadmin@erge-gateway ~]$ ssh erge-app01
[zyadmin@erge-app-01 ~]$

# 从客户gateway连接app02
[zyadmin@erge-gateway ~]$ ssh erge-app02



app01 192.168.3.1	redis-master	6379 consul   8600	
app02 192.168.3.2	redis-slave		6379 sentinel 26379 


我是负责reids实施，reids搭建计划如下：
1. redis 主从 —— app01 redis-master app02 redis-slave :实现冗余；读写功能为：主读写，从只读；
2. redis sentinel——实现故障后的主从架构恢复，具体为：app01 redis服务宕掉， app02 redis服务自动从slave升为master，app01的redis服务手动恢复后，系统能够自动将app01重新加入redis主动架构中成为slave；
3. consul——自动发现服务，能够解析redis.service.consul为当前的主redis节点，实现自动故障转移；
4. 前端应用程序连接redis，需使用redis.service.consul域名访问。



1.查看app的系统大概情况

[zyadmin@erge-app-02 ~]$ cat /etc/redhat-release 
CentOS Linux release 7.3.1611 (Core) 
[zyadmin@erge-app-02 ~]$ uname -a
Linux erge-app-02 3.10.0-514.21.2.el7.x86_64 #1 SMP Tue Jun 20 12:24:47 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
[zyadmin@erge-app-02 ~]$ uname -m
x86_64
[zyadmin@erge-app-02 ~]$ lscpu
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                4
On-line CPU(s) list:   0-3
Thread(s) per core:    1
Core(s) per socket:    4
Socket(s):             1
NUMA node(s):          1
Vendor ID:             GenuineIntel
CPU family:            6
Model:                 63
Model name:            Intel(R) Xeon(R) CPU E5-2680 v3 @ 2.50GHz
Stepping:              2
CPU MHz:               2494.224
BogoMIPS:              4988.44
Hypervisor vendor:     KVM
Virtualization type:   full
L1d cache:             32K
L1i cache:             32K
L2 cache:              256K
L3 cache:              30720K
NUMA node0 CPU(s):     0-3
[zyadmin@erge-app-02 ~]$ free -h
              total        used        free      shared  buff/cache   available
Mem:           7.6G        736M        5.5G        876K        1.4G        6.6G
Swap:            0B          0B          0B



2.传输文件
# 将安装代码传输到app01和app02

3.开始安装
[root@erge-app-02 ~]# bash RedisInstall.sh 
plz input redis master ip:192.168.3.1
plz input redis master port:6379
plz input redis master password:zyadmin
plz input redis slave ip:192.168.3.2
plz input redis slave port:6379
Install master or slave or end (m/s/end):s
cd src && make all
make[1]: Entering directory `/alidata/install/redis-3.2.9/src'
rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-rdb redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html
(cd ../deps && make distclean)
make[2]: Entering directory `/alidata/install/redis-3.2.9/deps'
(cd hiredis && make clean) > /dev/null || true
(cd linenoise && make clean) > /dev/null || true
(cd lua && make clean) > /dev/null || true
(cd geohash-int && make clean) > /dev/null || true
(cd jemalloc && [ -f Makefile ] && make distclean) > /dev/null || true
(rm -f .make-*)
make[2]: Leaving directory `/alidata/install/redis-3.2.9/deps'
(rm -f .make-*)
echo STD=-std=c99 -pedantic -DREDIS_STATIC='' >> .make-settings
echo WARN=-Wall -W >> .make-settings
echo OPT=-O2 >> .make-settings
echo MALLOC=jemalloc >> .make-settings
echo CFLAGS= >> .make-settings
echo LDFLAGS= >> .make-settings
echo REDIS_CFLAGS= >> .make-settings
echo REDIS_LDFLAGS= >> .make-settings
echo PREV_FINAL_CFLAGS=-std=c99 -pedantic -DREDIS_STATIC='' -Wall -W -O2 -g -ggdb   -I../deps/geohash-int -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -DUSE_JEMALLOC -I../deps/jemalloc/include >> .make-settings
echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic >> .make-settings
(cd ../deps && make hiredis linenoise lua geohash-int jemalloc)
make[2]: Entering directory `/alidata/install/redis-3.2.9/deps'
(cd hiredis && make clean) > /dev/null || true
(cd linenoise && make clean) > /dev/null || true
(cd lua && make clean) > /dev/null || true
(cd geohash-int && make clean) > /dev/null || true
(cd jemalloc && [ -f Makefile ] && make distclean) > /dev/null || true
(rm -f .make-*)
(echo "" > .make-cflags)
(echo "" > .make-ldflags)
MAKE hiredis
cd hiredis && make static
make[3]: Entering directory `/alidata/install/redis-3.2.9/deps/hiredis'
cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  net.c
cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  hiredis.c
cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  sds.c
cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  async.c
ar rcs libhiredis.a net.o hiredis.o sds.o async.o
make[3]: Leaving directory `/alidata/install/redis-3.2.9/deps/hiredis'
MAKE linenoise
cd linenoise && make
make[3]: Entering directory `/alidata/install/redis-3.2.9/deps/linenoise'
cc  -Wall -Os -g  -c linenoise.c
make[3]: Leaving directory `/alidata/install/redis-3.2.9/deps/linenoise'
MAKE lua
cd lua/src && make all CFLAGS="-O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC='' " MYLDFLAGS="" AR="ar rcu"
make[3]: Entering directory `/alidata/install/redis-3.2.9/deps/lua/src'
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lapi.o lapi.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lcode.o lcode.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldebug.o ldebug.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldo.o ldo.c
ldo.c: In function ‘f_parser’:
ldo.c:496:7: warning: unused variable ‘c’ [-Wunused-variable]
   int c = luaZ_lookahead(p->z);
       ^
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldump.o ldump.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lfunc.o lfunc.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lgc.o lgc.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o llex.o llex.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lmem.o lmem.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lobject.o lobject.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lopcodes.o lopcodes.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lparser.o lparser.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lstate.o lstate.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lstring.o lstring.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ltable.o ltable.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ltm.o ltm.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lundump.o lundump.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lvm.o lvm.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lzio.o lzio.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o strbuf.o strbuf.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o fpconv.o fpconv.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lauxlib.o lauxlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lbaselib.o lbaselib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldblib.o ldblib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o liolib.o liolib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lmathlib.o lmathlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o loslib.o loslib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ltablib.o ltablib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lstrlib.o lstrlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o loadlib.o loadlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o linit.o linit.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_cjson.o lua_cjson.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_struct.o lua_struct.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_cmsgpack.o lua_cmsgpack.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_bit.o lua_bit.c
ar rcu liblua.a lapi.o lcode.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o lundump.o lvm.o lzio.o strbuf.o fpconv.o lauxlib.o lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o loadlib.o linit.o lua_cjson.o lua_struct.o lua_cmsgpack.o lua_bit.o	# DLL needs all object files
ranlib liblua.a
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua.o lua.c
cc -o lua  lua.o liblua.a -lm 
liblua.a(loslib.o): In function `os_tmpname':
loslib.c:(.text+0x28c): warning: the use of `tmpnam' is dangerous, better use `mkstemp'
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o luac.o luac.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o print.o print.c
cc -o luac  luac.o print.o liblua.a -lm 
make[3]: Leaving directory `/alidata/install/redis-3.2.9/deps/lua/src'
MAKE geohash-int
cd geohash-int && make
make[3]: Entering directory `/alidata/install/redis-3.2.9/deps/geohash-int'
cc  -Wall -O2 -g  -c geohash.c
cc  -Wall -O2 -g  -c geohash_helper.c
make[3]: Leaving directory `/alidata/install/redis-3.2.9/deps/geohash-int'
MAKE jemalloc
cd jemalloc && ./configure --with-lg-quantum=3 --with-jemalloc-prefix=je_ --enable-cc-silence CFLAGS="-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops " LDFLAGS=""
checking for xsltproc... false
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ISO C89... none needed
checking how to run the C preprocessor... gcc -E
checking for grep that handles long lines and -e... /bin/grep
checking for egrep... /bin/grep -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... yes
checking for inttypes.h... yes
checking for stdint.h... yes
checking for unistd.h... yes
checking whether byte ordering is bigendian... no
checking size of void *... 8
checking size of int... 4
checking size of long... 8
checking size of intmax_t... 8
checking build system type... x86_64-unknown-linux-gnu
checking host system type... x86_64-unknown-linux-gnu
checking whether pause instruction is compilable... yes
checking for ar... ar
checking malloc.h usability... yes
checking malloc.h presence... yes
checking for malloc.h... yes
checking whether malloc_usable_size definition can use const argument... no
checking whether __attribute__ syntax is compilable... yes
checking whether compiler supports -fvisibility=hidden... yes
checking whether compiler supports -Werror... yes
checking whether tls_model attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether alloc_size attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether format(gnu_printf, ...) attribute is compilable... yes
checking whether compiler supports -Werror... yes
checking whether format(printf, ...) attribute is compilable... yes
checking for a BSD-compatible install... /bin/install -c
checking for ranlib... ranlib
checking for ld... /bin/ld
checking for autoconf... false
checking for memalign... yes
checking for valloc... yes
checking configured backtracing method... N/A
checking for sbrk... yes
checking whether utrace(2) is compilable... no
checking whether valgrind is compilable... no
checking whether a program using __builtin_ffsl is compilable... yes
checking LG_PAGE... 12
checking pthread.h usability... yes
checking pthread.h presence... yes
checking for pthread.h... yes
checking for pthread_create in -lpthread... yes
checking for library containing clock_gettime... none required
checking for secure_getenv... yes
checking for issetugid... no
checking for _malloc_thread_cleanup... no
checking for _pthread_mutex_init_calloc_cb... no
checking for TLS... yes
checking whether C11 atomics is compilable... no
checking whether atomic(9) is compilable... no
checking whether Darwin OSAtomic*() is compilable... no
checking whether madvise(2) is compilable... yes
checking whether to force 32-bit __sync_{add,sub}_and_fetch()... no
checking whether to force 64-bit __sync_{add,sub}_and_fetch()... no
checking for __builtin_clz... yes
checking whether Darwin OSSpin*() is compilable... no
checking whether glibc malloc hook is compilable... yes
checking whether glibc memalign hook is compilable... yes
checking whether pthreads adaptive mutexes is compilable... yes
checking for stdbool.h that conforms to C99... yes
checking for _Bool... yes
configure: creating ./config.status
config.status: creating Makefile
config.status: creating jemalloc.pc
config.status: creating doc/html.xsl
config.status: creating doc/manpages.xsl
config.status: creating doc/jemalloc.xml
config.status: creating include/jemalloc/jemalloc_macros.h
config.status: creating include/jemalloc/jemalloc_protos.h
config.status: creating include/jemalloc/jemalloc_typedefs.h
config.status: creating include/jemalloc/internal/jemalloc_internal.h
config.status: creating test/test.sh
config.status: creating test/include/test/jemalloc_test.h
config.status: creating config.stamp
config.status: creating bin/jemalloc-config
config.status: creating bin/jemalloc.sh
config.status: creating bin/jeprof
config.status: creating include/jemalloc/jemalloc_defs.h
config.status: creating include/jemalloc/internal/jemalloc_internal_defs.h
config.status: creating test/include/test/jemalloc_test_defs.h
config.status: executing include/jemalloc/internal/private_namespace.h commands
config.status: executing include/jemalloc/internal/private_unnamespace.h commands
config.status: executing include/jemalloc/internal/public_symbols.txt commands
config.status: executing include/jemalloc/internal/public_namespace.h commands
config.status: executing include/jemalloc/internal/public_unnamespace.h commands
config.status: executing include/jemalloc/internal/size_classes.h commands
config.status: executing include/jemalloc/jemalloc_protos_jet.h commands
config.status: executing include/jemalloc/jemalloc_rename.h commands
config.status: executing include/jemalloc/jemalloc_mangle.h commands
config.status: executing include/jemalloc/jemalloc_mangle_jet.h commands
config.status: executing include/jemalloc/jemalloc.h commands
===============================================================================
jemalloc version   : 4.0.3-0-ge9192eacf8935e29fc62fddc2701f7942b1cc02c
library revision   : 2

CONFIG             : --with-lg-quantum=3 --with-jemalloc-prefix=je_ --enable-cc-silence 'CFLAGS=-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops ' LDFLAGS=
CC                 : gcc
CFLAGS             : -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -fvisibility=hidden
CPPFLAGS           :  -D_GNU_SOURCE -D_REENTRANT
LDFLAGS            : 
EXTRA_LDFLAGS      : 
LIBS               :  -lpthread
TESTLIBS           : 
RPATH_EXTRA        : 

XSLTPROC           : false
XSLROOT            : 

PREFIX             : /usr/local
BINDIR             : /usr/local/bin
DATADIR            : /usr/local/share
INCLUDEDIR         : /usr/local/include
LIBDIR             : /usr/local/lib
MANDIR             : /usr/local/share/man

srcroot            : 
abs_srcroot        : /alidata/install/redis-3.2.9/deps/jemalloc/
objroot            : 
abs_objroot        : /alidata/install/redis-3.2.9/deps/jemalloc/

JEMALLOC_PREFIX    : je_
JEMALLOC_PRIVATE_NAMESPACE
                   : je_
install_suffix     : 
autogen            : 0
cc-silence         : 1
debug              : 0
code-coverage      : 0
stats              : 1
prof               : 0
prof-libunwind     : 0
prof-libgcc        : 0
prof-gcc           : 0
tcache             : 1
fill               : 1
utrace             : 0
valgrind           : 0
xmalloc            : 0
munmap             : 0
lazy_lock          : 0
tls                : 1
cache-oblivious    : 1
===============================================================================
cd jemalloc && make CFLAGS="-std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops " LDFLAGS="" lib/libjemalloc.a
make[3]: Entering directory `/alidata/install/redis-3.2.9/deps/jemalloc'
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/jemalloc.o src/jemalloc.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/arena.o src/arena.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/atomic.o src/atomic.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/base.o src/base.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/bitmap.o src/bitmap.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk.o src/chunk.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk_dss.o src/chunk_dss.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/chunk_mmap.o src/chunk_mmap.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ckh.o src/ckh.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/ctl.o src/ctl.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/extent.o src/extent.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/hash.o src/hash.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/huge.o src/huge.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mb.o src/mb.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/mutex.o src/mutex.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/pages.o src/pages.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/prof.o src/prof.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/quarantine.o src/quarantine.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/rtree.o src/rtree.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/stats.o src/stats.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tcache.o src/tcache.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/util.o src/util.c
gcc -std=gnu99 -Wall -pipe -g3 -O3 -funroll-loops  -c -D_GNU_SOURCE -D_REENTRANT -Iinclude -Iinclude -o src/tsd.o src/tsd.c
ar crus lib/libjemalloc.a src/jemalloc.o src/arena.o src/atomic.o src/base.o src/bitmap.o src/chunk.o src/chunk_dss.o src/chunk_mmap.o src/ckh.o src/ctl.o src/extent.o src/hash.o src/huge.o src/mb.o src/mutex.o src/pages.o src/prof.o src/quarantine.o src/rtree.o src/stats.o src/tcache.o src/util.o src/tsd.o
make[3]: Leaving directory `/alidata/install/redis-3.2.9/deps/jemalloc'
make[2]: Leaving directory `/alidata/install/redis-3.2.9/deps'
    CC adlist.o
    CC quicklist.o
    CC ae.o
    CC anet.o
    CC dict.o
    CC server.o
    CC sds.o
    CC zmalloc.o
    CC lzf_c.o
    CC lzf_d.o
    CC pqsort.o
    CC zipmap.o
    CC sha1.o
    CC ziplist.o
    CC release.o
    CC networking.o
    CC util.o
    CC object.o
    CC db.o
    CC replication.o
    CC rdb.o
    CC t_string.o
    CC t_list.o
    CC t_set.o
    CC t_zset.o
    CC t_hash.o
    CC config.o
    CC aof.o
    CC pubsub.o
    CC multi.o
    CC debug.o
    CC sort.o
    CC intset.o
    CC syncio.o
    CC cluster.o
    CC crc16.o
    CC endianconv.o
    CC slowlog.o
    CC scripting.o
    CC bio.o
    CC rio.o
    CC rand.o
    CC memtest.o
    CC crc64.o
    CC bitops.o
    CC sentinel.o
    CC notify.o
    CC setproctitle.o
    CC blocked.o
    CC hyperloglog.o
    CC latency.o
    CC sparkline.o
    CC redis-check-rdb.o
    CC geo.o
    LINK redis-server
    INSTALL redis-sentinel
    CC redis-cli.o
    LINK redis-cli
    CC redis-benchmark.o
    LINK redis-benchmark
    INSTALL redis-check-rdb
    CC redis-check-aof.o
    LINK redis-check-aof

Hint: It's a good idea to run 'make test' ;)

make[1]: Leaving directory `/alidata/install/redis-3.2.9/src'
cd src && make install
make[1]: Entering directory `/alidata/install/redis-3.2.9/src'

Hint: It's a good idea to run 'make test' ;)

    INSTALL install
    INSTALL install
    INSTALL install
    INSTALL install
    INSTALL install
make[1]: Leaving directory `/alidata/install/redis-3.2.9/src'
/alidata/redis/src/redis-server
/alidata/redis/src/redis-cli
total 224
-rw-rw-r--  1 root root 87407 May 17 23:39 00-RELEASENOTES
-rw-rw-r--  1 root root    53 May 17 23:39 BUGS
drwxr-xr-x  2 root root  4096 Jul 12 10:39 conf
-rw-rw-r--  1 root root  1805 May 17 23:39 CONTRIBUTING
-rw-rw-r--  1 root root  1487 May 17 23:39 COPYING
drwxr-xr-x  3 root root  4096 Jul 12 10:39 data
drwxrwxr-x  7 root root  4096 Jul 12 10:38 deps
-rw-rw-r--  1 root root    11 May 17 23:39 INSTALL
drwxr-xr-x  2 root root  4096 Jul 12 10:38 log
-rw-rw-r--  1 root root   151 May 17 23:39 Makefile
-rw-rw-r--  1 root root  4223 May 17 23:39 MANIFESTO
drwxr-xr-x  2 root root  4096 Jul 12 10:38 pid
-rw-rw-r--  1 root root  6834 May 17 23:39 README.md
-rw-rw-r--  1 root root 46695 May 17 23:39 redis.conf
-rwxrwxr-x  1 root root   271 May 17 23:39 runtest
-rwxrwxr-x  1 root root   280 May 17 23:39 runtest-cluster
-rwxrwxr-x  1 root root   281 May 17 23:39 runtest-sentinel
-rw-rw-r--  1 root root  7606 May 17 23:39 sentinel.conf
drwxrwxr-x  2 root root  4096 Jul 12 10:39 src
drwxrwxr-x 10 root root  4096 May 17 23:39 tests
drwxrwxr-x  7 root root  4096 May 17 23:39 utils
total 4
-rw-r--r-- 1 root root 1300 Jul 12 10:39 redis6379.conf
Install master or slave or end (m/s/end):end
config sentinel (yes or no):yes
plz input sentinel port:26379
total 8
-rw-r--r-- 1 root root 1300 Jul 12 10:39 redis6379.conf
-rw-r--r-- 1 root root  288 Jul 12 10:39 sentinel26379.conf
config sentinel (yes or no):no
install consul? (yes or no):yes
Archive:  consul_0.8.5_linux_amd64.zip
  inflating: consul                  
/bin/consul
total 8
drwxr-xr-x 2 root root 4096 Jul 12 10:39 conf
drwxr-xr-x 2 root root 4096 Jul 12 10:39 data
total 4
-rw-r--r-- 1 root root 825 Jul 12 10:39 redis.json
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.cloud.aliyuncs.com
 * epel: mirrors.cloud.aliyuncs.com
 * extras: mirrors.cloud.aliyuncs.com
 * updates: mirrors.cloud.aliyuncs.com
  Resolving Dependencies
  --> Running transaction check
  ---> Package bind.x86_64 32:9.9.4-50.el7_3.1 will be installed
  --> Processing Dependency: bind-libs = 32:9.9.4-50.el7_3.1 for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  --> Processing Dependency: liblwres.so.90()(64bit) for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  --> Processing Dependency: libisccfg.so.90()(64bit) for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  --> Processing Dependency: libisccc.so.90()(64bit) for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  --> Processing Dependency: libisc.so.95()(64bit) for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  --> Processing Dependency: libdns.so.100()(64bit) for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  --> Processing Dependency: libbind9.so.90()(64bit) for package: 32:bind-9.9.4-50.el7_3.1.x86_64
  ---> Package bind-chroot.x86_64 32:9.9.4-50.el7_3.1 will be installed
  --> Running transaction check
  ---> Package bind-libs.x86_64 32:9.9.4-50.el7_3.1 will be installed
  --> Processing Dependency: bind-license = 32:9.9.4-50.el7_3.1 for package: 32:bind-libs-9.9.4-50.el7_3.1.x86_64
  --> Running transaction check
  ---> Package bind-license.noarch 32:9.9.4-37.el7 will be updated
  --> Processing Dependency: bind-license = 32:9.9.4-37.el7 for package: 32:bind-libs-lite-9.9.4-37.el7.x86_64
  ---> Package bind-license.noarch 32:9.9.4-50.el7_3.1 will be an update
  --> Running transaction check
  ---> Package bind-libs-lite.x86_64 32:9.9.4-37.el7 will be updated
  ---> Package bind-libs-lite.x86_64 32:9.9.4-50.el7_3.1 will be an update
  --> Finished Dependency Resolution

Dependencies Resolved

======================================================================================================================================
 Package                           Arch                      Version                                 Repository                  Size
======================================================================================================================================
Installing:
 bind                              x86_64                    32:9.9.4-50.el7_3.1                     updates                    1.8 M
 bind-chroot                       x86_64                    32:9.9.4-50.el7_3.1                     updates                     85 k
Installing for dependencies:
 bind-libs                         x86_64                    32:9.9.4-50.el7_3.1                     updates                    1.0 M
Updating for dependencies:
 bind-libs-lite                    x86_64                    32:9.9.4-50.el7_3.1                     updates                    730 k
 bind-license                      noarch                    32:9.9.4-50.el7_3.1                     updates                     83 k

Transaction Summary
======================================================================================================================================
Install  2 Packages (+1 Dependent package)
Upgrade             ( 2 Dependent packages)

Total download size: 3.7 M
Downloading packages:
Delta RPMs disabled because /usr/bin/applydeltarpm not installed.
(1/5): bind-chroot-9.9.4-50.el7_3.1.x86_64.rpm                                                                 |  85 kB  00:00:00     
(2/5): bind-libs-9.9.4-50.el7_3.1.x86_64.rpm                                                                   | 1.0 MB  00:00:00     
(3/5): bind-libs-lite-9.9.4-50.el7_3.1.x86_64.rpm                                                              | 730 kB  00:00:00     
(4/5): bind-license-9.9.4-50.el7_3.1.noarch.rpm                                                                |  83 kB  00:00:00     
(5/5): bind-9.9.4-50.el7_3.1.x86_64.rpm                                                                        | 1.8 MB  00:00:00     
--------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                 8.6 MB/s | 3.7 MB  00:00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Updating   : 32:bind-license-9.9.4-50.el7_3.1.noarch                                                                            1/7 
  Installing : 32:bind-libs-9.9.4-50.el7_3.1.x86_64                                                                               2/7 
  Installing : 32:bind-9.9.4-50.el7_3.1.x86_64                                                                                    3/7 
  Installing : 32:bind-chroot-9.9.4-50.el7_3.1.x86_64                                                                             4/7 
  Updating   : 32:bind-libs-lite-9.9.4-50.el7_3.1.x86_64                                                                          5/7 
  Cleanup    : 32:bind-libs-lite-9.9.4-37.el7.x86_64                                                                              6/7 
  Cleanup    : 32:bind-license-9.9.4-37.el7.noarch                                                                                7/7 
  Verifying  : 32:bind-license-9.9.4-50.el7_3.1.noarch                                                                            1/7 
  Verifying  : 32:bind-libs-9.9.4-50.el7_3.1.x86_64                                                                               2/7 
  Verifying  : 32:bind-9.9.4-50.el7_3.1.x86_64                                                                                    3/7 
  Verifying  : 32:bind-chroot-9.9.4-50.el7_3.1.x86_64                                                                             4/7 
  Verifying  : 32:bind-libs-lite-9.9.4-50.el7_3.1.x86_64                                                                          5/7 
  Verifying  : 32:bind-libs-lite-9.9.4-37.el7.x86_64                                                                              6/7 
  Verifying  : 32:bind-license-9.9.4-37.el7.noarch                                                                                7/7 

Installed:
  bind.x86_64 32:9.9.4-50.el7_3.1                                bind-chroot.x86_64 32:9.9.4-50.el7_3.1                               

Dependency Installed:
  bind-libs.x86_64 32:9.9.4-50.el7_3.1                                                                                                

Dependency Updated:
  bind-libs-lite.x86_64 32:9.9.4-50.el7_3.1                          bind-license.noarch 32:9.9.4-50.el7_3.1                         

Complete!
Redirecting to /bin/systemctl restart  named.service
install consul? (yes or no):no



3. 启动reids和sentinel测试主从
  [root@erge-app-01 ~]# ./redisctl start 6379
  [root@erge-app-01 ~]# ps -ef|grep redi[s]
  root      3122     1  0 10:51 ?        00:00:00 redis-server 192.168.3.1:6379

[root@erge-app-01 ~]# redis-cli info replication
# Replication
role:master
connected_slaves:1
slave0:ip=192.168.3.2,port=6379,state=online,offset=11535,lag=1
master_repl_offset:11672
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2
repl_backlog_histlen:11671
[root@erge-app-01 ~]# redis-cli set name 'zy'
OK
[root@erge-app-01 ~]# redis-cli get name
"zy"

[root@erge-app-02 ~]# ./redisctl start 6379
[root@erge-app-02 ~]# ./redisctl sentinel 26379
[root@erge-app-02 ~]# ps -ef | grep redi[s]
root      9515     1  0 10:53 ?        00:00:00 /alidata/redis/src/redis-server 192.168.3.2:6379
root      9524     1  0 10:54 ?        00:00:00 /alidata/redis/src/redis-sentinel *:26379 [sentinel]
[root@erge-app-02 ~]# redis-cli info replication
# Replication
role:slave
master_host:192.168.3.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:4464
slave_priority:100
slave_read_only:1
connected_slaves:0
master_repl_offset:0
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
[root@erge-app-02 ~]# redis-cli get name
"zy"


4.启动consul
[root@erge-app-01 ~]# vim /etc/resolv.conf 
#options timeout:1 attempts:1 rotate single-request-reopen
#search localdomain
#nameserver 100.100.2.138
#nameserver 100.100.2.136
nameserver 192.168.3.1
[root@erge-app-01 ~]# tail -n 4 RedisInstall.sh 
# 最后手动启动consul服务并测试
#       nohup /bin/consul agent -dev  -config-dir=/alidata/consul/conf &> /alidata/consul/consul.log &
#       dig redis.service.consul.

[root@erge-app-01 ~]# nohup /bin/consul agent -dev  -config-dir=/alidata/consul/conf &> /alidata/consul/consul.log &
[1] 3389
[root@erge-app-01 ~]# ps -ef|grep consul
root      3389  3202  3 11:01 pts/3    00:00:00 /bin/consul agent -dev -config-dir=/alidata/consul/conf
root      3409  3202  0 11:01 pts/3    00:00:00 grep --color=auto consul
[root@erge-app-01 ~]# ss -luntp|grep consul
udp    UNCONN     0      0      127.0.0.1:8301                  *:*                   users:(("consul",pid=3389,fd=7))
udp    UNCONN     0      0      127.0.0.1:8302                  *:*                   users:(("consul",pid=3389,fd=9))
udp    UNCONN     0      0      127.0.0.1:8600                  *:*                   users:(("consul",pid=3389,fd=10))
tcp    LISTEN     0      32768  127.0.0.1:8300                  *:*                   users:(("consul",pid=3389,fd=4))
tcp    LISTEN     0      32768  127.0.0.1:8301                  *:*                   users:(("consul",pid=3389,fd=6))
tcp    LISTEN     0      32768  127.0.0.1:8302                  *:*                   users:(("consul",pid=3389,fd=8))
tcp    LISTEN     0      32768  127.0.0.1:8500                  *:*                   users:(("consul",pid=3389,fd=14))
tcp    LISTEN     0      32768  127.0.0.1:8600                  *:*                   users:(("consul",pid=3389,fd=13))

5. 测试consul
  [root@erge-app-01 ~]# dig @127.0.0.1 redis.service.consul.

; <<>> DiG 9.9.4-RedHat-9.9.4-50.el7_3.1 <<>> @127.0.0.1 redis.service.consul.
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 30914
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 13, ADDITIONAL: 27

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;redis.service.consul.		IN	A

;; ANSWER SECTION:
redis.service.consul.	0	IN	A	192.168.3.1

;; AUTHORITY SECTION:
.			517426	IN	NS	j.root-servers.net.
.			517426	IN	NS	i.root-servers.net.
.			517426	IN	NS	c.root-servers.net.
.			517426	IN	NS	b.root-servers.net.
.			517426	IN	NS	k.root-servers.net.
.			517426	IN	NS	m.root-servers.net.
.			517426	IN	NS	l.root-servers.net.
.			517426	IN	NS	h.root-servers.net.
.			517426	IN	NS	e.root-servers.net.
.			517426	IN	NS	f.root-servers.net.
.			517426	IN	NS	d.root-servers.net.
.			517426	IN	NS	g.root-servers.net.
.			517426	IN	NS	a.root-servers.net.

;; ADDITIONAL SECTION:
k.root-servers.net.	518373	IN	A	193.0.14.129
k.root-servers.net.	518373	IN	AAAA	2001:7fd::1
j.root-servers.net.	518373	IN	A	192.58.128.30
j.root-servers.net.	518373	IN	AAAA	2001:503:c27::2:30
e.root-servers.net.	518373	IN	A	192.203.230.10
e.root-servers.net.	518373	IN	AAAA	2001:500:a8::e
c.root-servers.net.	518373	IN	A	192.33.4.12
c.root-servers.net.	518373	IN	AAAA	2001:500:2::c
f.root-servers.net.	518373	IN	A	192.5.5.241
f.root-servers.net.	518373	IN	AAAA	2001:500:2f::f
i.root-servers.net.	518373	IN	A	192.36.148.17
i.root-servers.net.	518373	IN	AAAA	2001:7fe::53
l.root-servers.net.	518373	IN	A	199.7.83.42
l.root-servers.net.	518373	IN	AAAA	2001:500:9f::42
a.root-servers.net.	518373	IN	A	198.41.0.4
a.root-servers.net.	518373	IN	AAAA	2001:503:ba3e::2:30
b.root-servers.net.	518373	IN	A	192.228.79.201
b.root-servers.net.	518373	IN	AAAA	2001:500:200::b
g.root-servers.net.	518373	IN	A	192.112.36.4
g.root-servers.net.	518373	IN	AAAA	2001:500:12::d0d
h.root-servers.net.	518373	IN	A	198.97.190.53
h.root-servers.net.	518373	IN	AAAA	2001:500:1::53
m.root-servers.net.	518373	IN	A	202.12.27.33
m.root-servers.net.	518373	IN	AAAA	2001:dc3::35
d.root-servers.net.	518373	IN	A	199.7.91.13
d.root-servers.net.	518373	IN	AAAA	2001:500:2d::d

;; Query time: 1 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Wed Jul 12 11:02:39 CST 2017
;; MSG SIZE  rcvd: 848

[root@erge-app-01 ~]# dig @127.0.0.1 redis.service.consul. SRV

; <<>> DiG 9.9.4-RedHat-9.9.4-50.el7_3.1 <<>> @127.0.0.1 redis.service.consul. SRV
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 55728
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 13, ADDITIONAL: 28

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;redis.service.consul.		IN	SRV

;; ANSWER SECTION:
redis.service.consul.	0	IN	SRV	1 1 6379 c0a80301.addr.dc1.consul.

;; AUTHORITY SECTION:
.			517419	IN	NS	h.root-servers.net.
.			517419	IN	NS	j.root-servers.net.
.			517419	IN	NS	e.root-servers.net.
.			517419	IN	NS	b.root-servers.net.
.			517419	IN	NS	i.root-servers.net.
.			517419	IN	NS	k.root-servers.net.
.			517419	IN	NS	c.root-servers.net.
.			517419	IN	NS	g.root-servers.net.
.			517419	IN	NS	d.root-servers.net.
.			517419	IN	NS	a.root-servers.net.
.			517419	IN	NS	l.root-servers.net.
.			517419	IN	NS	m.root-servers.net.
.			517419	IN	NS	f.root-servers.net.

;; ADDITIONAL SECTION:
c0a80301.addr.dc1.consul. 0	IN	A	192.168.3.1
k.root-servers.net.	518366	IN	A	193.0.14.129
k.root-servers.net.	518366	IN	AAAA	2001:7fd::1
j.root-servers.net.	518366	IN	A	192.58.128.30
j.root-servers.net.	518366	IN	AAAA	2001:503:c27::2:30
e.root-servers.net.	518366	IN	A	192.203.230.10
e.root-servers.net.	518366	IN	AAAA	2001:500:a8::e
c.root-servers.net.	518366	IN	A	192.33.4.12
c.root-servers.net.	518366	IN	AAAA	2001:500:2::c
f.root-servers.net.	518366	IN	A	192.5.5.241
f.root-servers.net.	518366	IN	AAAA	2001:500:2f::f
i.root-servers.net.	518366	IN	A	192.36.148.17
i.root-servers.net.	518366	IN	AAAA	2001:7fe::53
l.root-servers.net.	518366	IN	A	199.7.83.42
l.root-servers.net.	518366	IN	AAAA	2001:500:9f::42
a.root-servers.net.	518366	IN	A	198.41.0.4
a.root-servers.net.	518366	IN	AAAA	2001:503:ba3e::2:30
b.root-servers.net.	518366	IN	A	192.228.79.201
b.root-servers.net.	518366	IN	AAAA	2001:500:200::b
g.root-servers.net.	518366	IN	A	192.112.36.4
g.root-servers.net.	518366	IN	AAAA	2001:500:12::d0d
h.root-servers.net.	518366	IN	A	198.97.190.53
h.root-servers.net.	518366	IN	AAAA	2001:500:1::53
m.root-servers.net.	518366	IN	A	202.12.27.33
m.root-servers.net.	518366	IN	AAAA	2001:dc3::35
d.root-servers.net.	518366	IN	A	199.7.91.13
d.root-servers.net.	518366	IN	AAAA	2001:500:2d::d

;; Query time: 1 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Wed Jul 12 11:02:46 CST 2017
;; MSG SIZE  rcvd: 892

[root@erge-app-01 ~]# 
[root@erge-app-01 ~]# dig redis.service.consul

; <<>> DiG 9.9.4-RedHat-9.9.4-50.el7_3.1 <<>> redis.service.consul
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 63041
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 13, ADDITIONAL: 27

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;redis.service.consul.		IN	A

;; ANSWER SECTION:
redis.service.consul.	0	IN	A	192.168.3.1

;; AUTHORITY SECTION:
.			517399	IN	NS	j.root-servers.net.
.			517399	IN	NS	d.root-servers.net.
.			517399	IN	NS	g.root-servers.net.
.			517399	IN	NS	h.root-servers.net.
.			517399	IN	NS	c.root-servers.net.
.			517399	IN	NS	b.root-servers.net.
.			517399	IN	NS	m.root-servers.net.
.			517399	IN	NS	l.root-servers.net.
.			517399	IN	NS	k.root-servers.net.
.			517399	IN	NS	f.root-servers.net.
.			517399	IN	NS	a.root-servers.net.
.			517399	IN	NS	e.root-servers.net.
.			517399	IN	NS	i.root-servers.net.

;; ADDITIONAL SECTION:
k.root-servers.net.	518346	IN	A	193.0.14.129
k.root-servers.net.	518346	IN	AAAA	2001:7fd::1
j.root-servers.net.	518346	IN	A	192.58.128.30
j.root-servers.net.	518346	IN	AAAA	2001:503:c27::2:30
e.root-servers.net.	518346	IN	A	192.203.230.10
e.root-servers.net.	518346	IN	AAAA	2001:500:a8::e
c.root-servers.net.	518346	IN	A	192.33.4.12
c.root-servers.net.	518346	IN	AAAA	2001:500:2::c
f.root-servers.net.	518346	IN	A	192.5.5.241
f.root-servers.net.	518346	IN	AAAA	2001:500:2f::f
i.root-servers.net.	518346	IN	A	192.36.148.17
i.root-servers.net.	518346	IN	AAAA	2001:7fe::53
l.root-servers.net.	518346	IN	A	199.7.83.42
l.root-servers.net.	518346	IN	AAAA	2001:500:9f::42
a.root-servers.net.	518346	IN	A	198.41.0.4
a.root-servers.net.	518346	IN	AAAA	2001:503:ba3e::2:30
b.root-servers.net.	518346	IN	A	192.228.79.201
b.root-servers.net.	518346	IN	AAAA	2001:500:200::b
g.root-servers.net.	518346	IN	A	192.112.36.4
g.root-servers.net.	518346	IN	AAAA	2001:500:12::d0d
h.root-servers.net.	518346	IN	A	198.97.190.53
h.root-servers.net.	518346	IN	AAAA	2001:500:1::53
m.root-servers.net.	518346	IN	A	202.12.27.33
m.root-servers.net.	518346	IN	AAAA	2001:dc3::35
d.root-servers.net.	518346	IN	A	199.7.91.13
d.root-servers.net.	518346	IN	AAAA	2001:500:2d::d

;; Query time: 1 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Wed Jul 12 11:03:06 CST 2017
;; MSG SIZE  rcvd: 848

[root@erge-app-01 ~]# ping redis.service.consul
PING redis.service.consul (192.168.3.1) 56(84) bytes of data.
64 bytes from erge-app-01 (192.168.3.1): icmp_seq=1 ttl=64 time=0.016 ms
64 bytes from erge-app-01 (192.168.3.1): icmp_seq=2 ttl=64 time=0.025 ms
^C
--- redis.service.consul ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 0.016/0.020/0.025/0.006 ms


[root@erge-app-02 ~]# cat /etc/resolv.conf
#options timeout:1 attempts:1 rotate single-request-reopen
#search localdomain
#nameserver 100.100.2.138
#nameserver 100.100.2.136
nameserver 192.168.3.1
[root@erge-app-02 ~]# ping redis.service.consul
PING redis.service.consul (192.168.3.1) 56(84) bytes of data.
64 bytes from 192.168.3.1 (192.168.3.1): icmp_seq=1 ttl=64 time=0.168 ms
^C
--- redis.service.consul ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.168/0.168/0.168/0.000 ms
[root@erge-app-02 ~]# redis-cli -h redis.service.consul
redis.service.consul:6379> get name
"zy"
redis.service.consul:6379> info replication
# Replication
role:master
connected_slaves:1
slave0:ip=192.168.3.2,port=6379,state=online,offset=91715,lag=0
master_repl_offset:91715
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2
repl_backlog_histlen:91714
redis.service.consul:6379> exit

6.测试故障转移动

[root@erge-app-01 ~]# ps -ef|grep redi[s]
root     10996     1  0 12:32 ?        00:00:00 /alidata/redis/src/redis-server 192.168.3.1:6379
[root@erge-app-01 ~]# ps -ef|grep consul
root      3389  3202  1 11:01 pts/3    00:01:15 /bin/consul agent -dev -config-dir=/alidata/consul/conf
root     11337  5659  0 12:36 pts/6    00:00:00 grep --color=auto consul


[root@erge-app-02 ~]# ps -ef|grep redi[s]
root     10603     1  0 12:17 ?        00:00:01 /alidata/redis/src/redis-server 192.168.3.2:6379
root     10786     1  0 12:33 ?        00:00:00 /alidata/redis/src/redis-sentinel *:26379 [sentinel]

[zyadmin@erge-app-02 ~]$ tail -f /alidata/redis/log/sentinel26379.log
 |`-._`-._    `-.__.-'    _.-'_.-'|                                  
 |    `-._`-._        _.-'_.-'    |                                  
  `-._    `-._`-.__.-'_.-'    _.-'                                   
      `-._    `-.__.-'    _.-'                                       
          `-._        _.-'                                           
              `-.__.-'                                               

10786:X 12 Jul 12:33:46.874 # Sentinel ID is 5d46c21fea3cf9779c51a26d555bf003994c3aad
10786:X 12 Jul 12:33:46.875 # +monitor master mymaster 192.168.3.1 6379 quorum 2
10786:X 12 Jul 12:33:46.876 * +slave slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379

[root@erge-app-01 ~]# tail -f /alidata/consul/consul.log 
    2017/07/12 12:37:22 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: role:master
    2017/07/12 12:37:22 [DEBUG] agent: Check 'service:redisnode1' is passing
    2017/07/12 12:37:23 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:37:23 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:37:27 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: role:master
    2017/07/12 12:37:27 [DEBUG] agent: Check 'service:redisnode1' is passing
    2017/07/12 12:37:28 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:37:28 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:37:32 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: role:master
    2017/07/12 12:37:32 [DEBUG] agent: Check 'service:redisnode1' is passing
    2017/07/12 12:37:33 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:37:33 [WARN] agent: Check 'service:redisnode2' is now critical


[root@erge-app-01 ~]# ping -c 2 redis.service.consul
PING redis.service.consul (192.168.3.1) 56(84) bytes of data.
64 bytes from erge-app-01 (192.168.3.1): icmp_seq=1 ttl=64 time=0.025 ms
64 bytes from erge-app-01 (192.168.3.1): icmp_seq=2 ttl=64 time=0.036 ms

--- redis.service.consul ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1000ms
rtt min/avg/max/mdev = 0.025/0.030/0.036/0.007 ms

[root@erge-app-01 ~]# redis-cli shutdown

[root@erge-app-02 ~]# tail -f /alidata/redis/log/sentinel26379.log 
 |`-._`-._    `-.__.-'    _.-'_.-'|                                  
 |    `-._`-._        _.-'_.-'    |                                  
  `-._    `-._`-.__.-'_.-'    _.-'                                   
      `-._    `-.__.-'    _.-'                                       
          `-._        _.-'                                           
              `-.__.-'                                               

10913:X 12 Jul 12:43:21.316 # Sentinel ID is 86cc9ef992e888e694821d6969a656a253ba8f63
10913:X 12 Jul 12:43:21.316 # +monitor master mymaster 192.168.3.1 6379 quorum 1
10913:X 12 Jul 12:43:21.317 * +slave slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.617 # +sdown master mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.617 # +odown master mymaster 192.168.3.1 6379 #quorum 1/1
10913:X 12 Jul 12:44:07.617 # +new-epoch 1
10913:X 12 Jul 12:44:07.617 # +try-failover master mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.620 # +vote-for-leader 86cc9ef992e888e694821d6969a656a253ba8f63 1
10913:X 12 Jul 12:44:07.620 # +elected-leader master mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.620 # +failover-state-select-slave master mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.672 # +selected-slave slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.672 * +failover-state-send-slaveof-noone slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:07.727 * +failover-state-wait-promotion slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:08.142 # +promoted-slave slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:08.142 # +failover-state-reconf-slaves master mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:08.201 # +failover-end master mymaster 192.168.3.1 6379
10913:X 12 Jul 12:44:08.201 # +switch-master mymaster 192.168.3.1 6379 192.168.3.2 6379
10913:X 12 Jul 12:44:08.201 * +slave slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379
10913:X 12 Jul 12:44:38.241 # +sdown slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379




consul的日志显示整个切换过程从12:43:37到12:44:08，一共个耗时31s

    2017/07/12 12:43:37 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:43:37 [DEBUG] agent: Service 'consul' in sync
    2017/07/12 12:43:37 [DEBUG] agent: Service 'redisnode1' in sync
    2017/07/12 12:43:37 [DEBUG] agent: Service 'redisnode2' in sync
    2017/07/12 12:43:37 [INFO] agent: Synced check 'service:redisnode1'
    2017/07/12 12:43:37 [DEBUG] agent: Check 'service:redisnode2' in sync
    2017/07/12 12:43:37 [DEBUG] agent: Node info in sync
    2017/07/12 12:43:38 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:43:38 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:43:42 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.1:6379: Connection refused
    2017/07/12 12:43:42 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:43:43 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:43:43 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:43:45 [DEBUG] manager: Rebalanced 1 servers, next active server is erge-app-01.dc1 (Addr: tcp/127.0.0.1:8300) (DC: dc1)
    2017/07/12 12:43:47 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.1:6379: Connection refused
    2017/07/12 12:43:47 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:43:48 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:43:48 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:43:52 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.1:6379: Connection refused
    2017/07/12 12:43:52 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:43:53 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:43:53 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:43:57 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.1:6379: Connection refused
    2017/07/12 12:43:57 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:43:58 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:43:58 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:44:02 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.1:6379: Connection refused
    2017/07/12 12:44:02 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:44:03 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: 
    2017/07/12 12:44:03 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:44:07 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.1:6379: Connection refused
    2017/07/12 12:44:07 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:44:08 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: role:master
    2017/07/12 12:44:08 [DEBUG] agent: Check 'service:redisnode2' is passing


[root@erge-app-01 ~]# ping -c 2 redis.service.consul
PING redis.service.consul (192.168.3.2) 56(84) bytes of data.
64 bytes from 192.168.3.2 (192.168.3.2): icmp_seq=1 ttl=64 time=0.325 ms
64 bytes from 192.168.3.2 (192.168.3.2): icmp_seq=2 ttl=64 time=0.244 ms

--- redis.service.consul ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.244/0.284/0.325/0.043 ms

[root@erge-app-01 ~]# redis-cli -h redis.service.consul info replication
# Replication
role:master
connected_slaves:0
master_repl_offset:0
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
[root@erge-app-01 ~]# redis-cli -h redis.service.consul set test zy
OK
[root@erge-app-01 ~]# redis-cli -h redis.service.consul get test
"zy"

# 恢复故障节点app01
[root@erge-app-01 ~]# ./redisctl start 6379

查看sentinel日志

10913:X 12 Jul 12:48:05.567 # -sdown slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379
10913:X 12 Jul 12:48:15.519 * +convert-to-slave slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379

[root@erge-app-01 ~]# redis-cli info replication
# Replication
role:slave
master_host:192.168.3.2
master_port:6379
master_link_status:up
master_last_io_seconds_ago:2
master_sync_in_progress:0
slave_repl_offset:586
slave_priority:100
slave_read_only:1
connected_slaves:0
master_repl_offset:0
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

[root@erge-app-01 ~]# redis-cli -h redis.service.consul info replication
# Replication
role:master
connected_slaves:1
slave0:ip=192.168.3.1,port=6379,state=online,offset=8988,lag=0
master_repl_offset:8988
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2
repl_backlog_histlen:8987

================
模拟app02故障
[root@erge-app-02 ~]# redis-cli shutdown

sentinel日志：
10913:X 12 Jul 12:51:24.102 # +sdown master mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.102 # +odown master mymaster 192.168.3.2 6379 #quorum 1/1
10913:X 12 Jul 12:51:24.102 # +new-epoch 2
10913:X 12 Jul 12:51:24.102 # +try-failover master mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.105 # +vote-for-leader 86cc9ef992e888e694821d6969a656a253ba8f63 2
10913:X 12 Jul 12:51:24.105 # +elected-leader master mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.105 # +failover-state-select-slave master mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.189 # +selected-slave slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.189 * +failover-state-send-slaveof-noone slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.251 * +failover-state-wait-promotion slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.408 # +promoted-slave slave 192.168.3.1:6379 192.168.3.1 6379 @ mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.408 # +failover-state-reconf-slaves master mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.496 # +failover-end master mymaster 192.168.3.2 6379
10913:X 12 Jul 12:51:24.496 # +switch-master mymaster 192.168.3.2 6379 192.168.3.1 6379
10913:X 12 Jul 12:51:24.496 * +slave slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:51:54.505 # +sdown slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379


consul日志 12:50:54~12:51:28 耗时32s

	2017/07/12 12:50:54 [WARN] agent: Check 'service:redisnode2' is now critical
......
    2017/07/12 12:51:23 [WARN] agent: Check 'service:redisnode1' is now critical
    2017/07/12 12:51:24 [DEBUG] agent: Check 'service:redisnode2' script 'redis-cli -h 192.168.3.2 -p 6379 info | grep role:master || exit 2' output: Could not connect to Redis at 192.168.3.2:6379: Connection refused
    2017/07/12 12:51:24 [WARN] agent: Check 'service:redisnode2' is now critical
    2017/07/12 12:51:28 [DEBUG] agent: Check 'service:redisnode1' script 'redis-cli -h 192.168.3.1 -p 6379 info | grep role:master || exit 2' output: role:master
    2017/07/12 12:51:28 [DEBUG] agent: Check 'service:redisnode1' is passing


[root@erge-app-01 ~]# redis-cli -h redis.service.consul info replication
# Replication
role:master
connected_slaves:0
master_repl_offset:0
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
[root@erge-app-01 ~]# ping -c 2 redis.service.consul
PING redis.service.consul (192.168.3.1) 56(84) bytes of data.
64 bytes from erge-app-01 (192.168.3.1): icmp_seq=1 ttl=64 time=0.018 ms
64 bytes from erge-app-01 (192.168.3.1): icmp_seq=2 ttl=64 time=0.035 ms

--- redis.service.consul ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1000ms
rtt min/avg/max/mdev = 0.018/0.026/0.035/0.009 ms

# 手动恢复故障节点app02
[root@erge-app-02 ~]# ./redisctl start 6379

sentinel日志 耗时10s将其加入主从架构中
10913:X 12 Jul 12:58:22.653 # -sdown slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379
10913:X 12 Jul 12:58:32.604 * +convert-to-slave slave 192.168.3.2:6379 192.168.3.2 6379 @ mymaster 192.168.3.1 6379

[root@erge-app-01 ~]# redis-cli -h redis.service.consul info replication
# Replication
role:master
connected_slaves:1
slave0:ip=192.168.3.2,port=6379,state=online,offset=449,lag=0
master_repl_offset:449
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2
repl_backlog_histlen:448
```










